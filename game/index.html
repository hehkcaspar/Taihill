<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ladder of Longivity</title>
    <link rel="icon" type="image/png" href="./icon/RB_color.png">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e;
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            color: #e0e0e0;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 5px solid #4a4a8a;
            background-color: #0f0f1a;
            box-shadow: 0 0 20px rgba(74, 74, 138, 0.7);
            padding: 10px;
            border-radius: 15px;
        }

        canvas {
            display: block;
            background-color: #000;
            max-width: 100%;
            max-height: 80vh;
            aspect-ratio: 3 / 4;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
            touch-action: none;
        }

        #uiContainer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 15px;
            box-sizing: border-box;
            font-size: 14px;
            color: #00ffcc;
            text-shadow: 0 0 5px #00ffcc;
        }

        #uiContainer>div {
            flex-basis: 33%;
        }

        #uiContainer #score {
            text-align: left;
        }

        #uiContainer #level {
            text-align: center;
        }

        #uiContainer #lives {
            text-align: right;
            color: red;
            font-size: 18px;
        }

        .messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            padding: 20px 30px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            display: none;
            z-index: 10;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            width: 80%;
            max-width: 350px;
        }

        .messageBox button {
            margin-top: 15px;
            padding: 10px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            text-shadow: 1px 1px 2px black;
            transition: all 0.1s ease;
            margin-left: 5px;
            margin-right: 5px;
            display: inline-block;
        }

        .messageBox button:active {
            transform: translateY(3px);
        }

        #gameOverBox {
            color: #ff4d4d;
            border: 3px solid #ff4d4d;
            box-shadow: 0 0 15px rgba(255, 77, 77, 0.6);
        }

        #gameOverBox button {
            background-color: #4CAF50;
            box-shadow: 0 4px #388E3C;
        }

        #gameOverBox button:active {
            box-shadow: 0 1px #388E3C;
        }

        #pauseMenu {
            color: #4da6ff;
            border: 3px solid #4da6ff;
            box-shadow: 0 0 15px rgba(77, 166, 255, 0.6);
        }

        #resumeButton {
            background-color: #ffae42;
            box-shadow: 0 4px #cc8400;
        }

        #resumeButton:active {
            box-shadow: 0 1px #cc8400;
        }

        #pauseRestartButton {
            background-color: #4CAF50;
            box-shadow: 0 4px #388E3C;
        }

        #pauseRestartButton:active {
            box-shadow: 0 1px #388E3C;
        }

        .sound-toggle-container {
            margin-top: 20px;
            text-align: center;
        }

        .sound-toggle-container button {
            font-size: 12px;
            padding: 8px 12px;
            min-width: 130px;
            box-sizing: border-box;
        }

        .sound-toggle-on {
            background-color: #34a853;
            box-shadow: 0 4px #2a8c4a;
        }

        .sound-toggle-on:active {
            box-shadow: 0 1px #2a8c4a;
        }

        .sound-toggle-off {
            background-color: #ea4335;
            box-shadow: 0 4px #b33021;
        }

        .sound-toggle-off:active {
            box-shadow: 0 1px #b33021;
        }

        #controlsInfo {
            margin-top: 15px;
            font-size: 10px;
            color: #aaa;
            text-align: center;
        }

        #touchControls {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 100px;
            display: none;
            pointer-events: none;
            z-index: 5;
        }

        .touch-control {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(128, 128, 128, 0.2);
            pointer-events: auto;
            transition: background-color 0.1s ease;
        }

        .touch-control.active {
            background-color: rgba(128, 128, 128, 0.5);
        }

        #joystickBase {
            bottom: 15px;
            left: 15px;
            width: 80px;
            height: 80px;
        }

        #joystickKnob {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: rgba(200, 200, 200, 0.3);
            border-radius: 50%;
            top: 20px;
            left: 20px;
            pointer-events: none;
        }

        #shootButton {
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
        }

        #pauseButton {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(128, 128, 128, 0.3);
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
    <div id="gameContainer">
        <div id="uiContainer">
            <div id="score">Score 0</div>
            <div id="level">Lifespan 50</div>
            <div id="lives">❤️❤️❤️</div>
        </div>
        <canvas id="gameCanvas" width="450" height="600"></canvas>

        <div id="touchControls">
            <div id="joystickBase" class="touch-control">
                <div id="joystickKnob"></div>
            </div>
            <div id="shootButton" class="touch-control"></div>
            <div id="pauseButton">||</div>
        </div>

        <div id="gameOverBox" class="messageBox">
            <div>Game Over!</div>
            <div id="finalScore">Final Score 0</div>
            <button id="restartButton">Restart</button>
        </div>
        <div id="pauseMenu" class="messageBox">
            <div>Paused</div>
            <div>
                <button id="resumeButton">Resume</button>
                <button id="pauseRestartButton">Restart</button>
            </div>
            <div class="sound-toggle-container">
                <button id="shootSoundToggle">Shoot FX: OFF</button>
                <button id="enemyHitSoundToggle">Hit FX: ON</button>
            </div>
        </div>
        <div id="controlsInfo">
            <span id="controlInstructions">Arrow Keys (Move), Space (Shoot), Esc (Pause)</span>
            <div id="eventStatus" style="font-size: 10px; color: yellow; height: 12px; margin-top: 5px;"></div>
        </div>
    </div>

    <script>
        // Global reference for the animation frame
        let animationFrameId = null;
        // Global references to DOM elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const lifespanDisplay = document.getElementById('level');
        const livesDisplay = document.getElementById('lives');
        const gameOverBox = document.getElementById('gameOverBox');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const pauseMenu = document.getElementById('pauseMenu');
        const resumeButton = document.getElementById('resumeButton');
        const pauseRestartButton = document.getElementById('pauseRestartButton');
        const shootSoundToggleButton = document.getElementById('shootSoundToggle');
        const enemyHitSoundToggleButton = document.getElementById('enemyHitSoundToggle');
        const eventStatusDisplay = document.getElementById('eventStatus');
        const touchControlsContainer = document.getElementById('touchControls');
        const joystickBase = document.getElementById('joystickBase');
        const joystickKnob = document.getElementById('joystickKnob');
        const shootButton = document.getElementById('shootButton');
        const pauseButton = document.getElementById('pauseButton');
        const controlInstructionsDisplay = document.getElementById('controlInstructions');
        const gameContainer = document.getElementById('gameContainer');

        // --- Sound Setup (Global) ---
        let soundsReady = false;
        let shootSoundEnabled = false;
        let enemyHitSoundEnabled = true;
        let playerHitSoundEnabled = true;

        const synth = new Tone.Synth().toDestination();
        const metalSynth = new Tone.MetalSynth({ frequency: 100, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, harmonicity: 3.1, modulationIndex: 16, resonance: 2000, octaves: 0.5 }).toDestination();
        const noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();

        function playShootSound() { if (!shootSoundEnabled || !soundsReady) return; try { synth.triggerAttackRelease("E5", "16n"); } catch (e) { console.error("Shoot sound error:", e); } }
        function playEnemyHitSound() { if (!enemyHitSoundEnabled || !soundsReady) return; try { metalSynth.triggerAttackRelease("8n"); } catch (e) { console.error("Enemy hit sound error:", e); } }
        function playPlayerHitSound() { if (!playerHitSoundEnabled || !soundsReady) return; try { noiseSynth.triggerAttackRelease("8n"); } catch (e) { console.error("Player hit sound error:", e); } }

        function initializeAudio() { if (Tone.context.state !== 'running') { Tone.start().then(() => { soundsReady = true; }).catch(e => { console.error("Failed to start AudioContext:", e); }); } else { soundsReady = true; } }
        document.body.addEventListener('click', initializeAudio, { once: true });
        document.body.addEventListener('keydown', initializeAudio, { once: true });

        // --- Player Image Loading (Global) ---
        const playerImage = new Image();
        let playerImageLoaded = false;
        playerImage.onload = () => { playerImageLoaded = true; };
        playerImage.onerror = () => { console.error("Failed to load player image (RB_bw.png). Using fallback."); };
        playerImage.src = './icon/RB_bw.png'; // Base player image

        const playerEvolvedImage = new Image();
        let playerEvolvedImageLoaded = false;
        playerEvolvedImage.onload = () => { playerEvolvedImageLoaded = true; };
        playerEvolvedImage.onerror = () => { console.error("Failed to load evolved player image (RB_color.png). Using fallback."); };
        playerEvolvedImage.src = './icon/RB_color.png'; // Evolved player image

        // --- Named Event Handlers References (needed for removal) ---
        let handleKeyDownRef; let handleKeyUpRef; let handleRestartClickRef;
        let handleResumeClickRef; let handlePauseRestartClickRef;
        let handleShootToggleRef; let handleEnemyHitSoundToggleRef;
        let handleJoystickStartRef, handleJoystickMoveRef, handleJoystickEndRef;
        let handleShootButtonStartRef, handleShootButtonEndRef;
        let handlePauseButtonTapRef;

        // --- Touch Detection ---
        function isTouchDevice() {
            return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
        }

        // --- Main Game Initialization Function ---
        function initGame() {
            console.log("Initializing game...");

            // --- Game State Variables (Re-initialized) ---
            let score = 0;
            let lifespan = 50;
            const maxLifespan = 200;
            let lives = 3;
            let gameOver = false;
            let isPaused = false;
            let gameRunning = true;
            let enemySpawnTimer = 0;
            let baseEnemySpawnInterval = 120;
            let lifespanIncreaseScore = 500;
            const keys = {};
            let isEvolved = false;
            const evolutionLifespan = 70;

            // --- Touch Control State ---
            let touchDevice = isTouchDevice();
            let joystickActive = false;
            let joystickTouchId = null;
            let joystickStartX = 0;
            let joystickStartY = 0;
            let shootButtonPressed = false;
            let currentJoystickRadius = 0;
            let currentMaxJoystickDisplacement = 0;

            // --- Health Event Variables ---
            let isEventActive = false;
            let currentEvent = null;
            let eventTimer = 0;
            const EVENT_DURATION = 600;
            const EVENT_DURATION_INCREASE_PER_LIFESPAN_SEC = 0.1;
            const EVENT_DURATION_INCREASE_PER_LIFESPAN_FRAMES = EVENT_DURATION_INCREASE_PER_LIFESPAN_SEC * 60;
            let eventCooldownTimer = 600;
            const EVENT_COOLDOWN = 1200;
            const healthEvents = ['heart_attack', 'cancer', 'depression', 'fever'];
            const DEPRESSION_MOVE_FACTOR = 0.4;
            const DEPRESSION_SHOOT_FACTOR = 3;
            const CANCER_ENEMY_HEALTH = 5;
            const CANCER_ENEMY_SIZE_FACTOR = 2;
            const HEART_ATTACK_INTENSITY = 20;
            const HEART_ATTACK_SHOOT_COOLDOWN_MULTIPLIER = 2;
            const EVENT_SCORE_MULTIPLIER = 2;
            const FEVER_SPAWN_INTERVAL_MULTIPLIER = 0.5;
            const FEVER_BULLET_SPEED_MULTIPLIER = 2;
            const FEVER_PLAYER_SPEED_MULTIPLIER = 1.5;
            const FEVER_SHOOT_COOLDOWN_MULTIPLIER = 0.5;
            const MIN_ENEMY_SHOOT_COOLDOWN = 15;

            // --- Game Element Objects (Re-initialized) ---
            const player = { x: canvas.width / 2 - 20, y: canvas.height - 60, width: 35, height: 35, speed: 4, dx: 0, dy: 0, shootCooldown: 0, shootCooldownDuration: 18, fallbackColor: '#FF6B6B', invulnerable: false, invulnerableTimer: 0 };
            const bullets = [];
            const enemies = [];
            const enemyBullets = [];
            const enemyEmojis = ['🍔', '🚬', '🍺', '🦠', '🤯', '🛋️', '💊', '💉', '💼', '📱', '🥤', '😴', '🏭', '💸', '💔'];

            // --- Define Event Handlers ---
            handleKeyDownRef = function handleKeyDown(e) {
                if (e.code === 'Escape') { e.preventDefault(); if (!gameOver) { togglePause(); } }
                if (gameRunning && !isPaused) { keys[e.code] = true; if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) { e.preventDefault(); } }
            };
            handleKeyUpRef = function handleKeyUp(e) { keys[e.code] = false; };
            handleRestartClickRef = restartGame;
            handlePauseRestartClickRef = restartGame;
            handleResumeClickRef = function handleResumeClick() { resumeGame(); };
            handleShootToggleRef = function handleShootToggle() { shootSoundEnabled = !shootSoundEnabled; updateSoundTogglesUI(); };
            handleEnemyHitSoundToggleRef = function handleEnemyHitSoundToggle() { enemyHitSoundEnabled = !enemyHitSoundEnabled; updateSoundTogglesUI(); };

            // --- Touch Event Handlers ---
            handleJoystickStartRef = function handleJoystickStart(e) {
                e.preventDefault();
                if (joystickActive) return;

                currentJoystickRadius = joystickBase.offsetWidth / 2;
                const currentKnobRadius = joystickKnob.offsetWidth / 2;
                currentMaxJoystickDisplacement = currentJoystickRadius - currentKnobRadius;

                if (currentJoystickRadius <= 0) {
                    console.error("Joystick dimensions not ready.");
                    return;
                }

                const touch = e.changedTouches[0];
                joystickTouchId = touch.identifier;
                joystickActive = true;
                const rect = joystickBase.getBoundingClientRect();
                joystickStartX = rect.left + currentJoystickRadius;
                joystickStartY = rect.top + currentJoystickRadius;
                joystickBase.classList.add('active');
                updateJoystick(touch.clientX, touch.clientY);
            };

            handleJoystickMoveRef = function handleJoystickMove(e) {
                e.preventDefault();
                if (!joystickActive) return;
                const touch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                if (touch) {
                    updateJoystick(touch.clientX, touch.clientY);
                }
            };

            handleJoystickEndRef = function handleJoystickEnd(e) {
                if (!joystickActive) return;
                const touch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                if (touch) {
                    joystickActive = false;
                    joystickTouchId = null;
                    player.dx = 0;
                    player.dy = 0;
                    joystickKnob.style.transform = `translate(0px, 0px)`;
                    joystickBase.classList.remove('active');
                }
            };

            handleShootButtonStartRef = function handleShootButtonStart(e) {
                e.preventDefault();
                shootButtonPressed = true;
                shootButton.classList.add('active');
            };

            handleShootButtonEndRef = function handleShootButtonEnd(e) {
                e.preventDefault();
                let stillTouchingButton = false;
                for (let i = 0; i < e.touches.length; i++) {
                    const touch = e.touches[i];
                    const buttonRect = shootButton.getBoundingClientRect();
                    if (touch.clientX >= buttonRect.left && touch.clientX <= buttonRect.right &&
                        touch.clientY >= buttonRect.top && touch.clientY <= buttonRect.bottom) {
                        stillTouchingButton = true;
                        break;
                    }
                }
                if (!stillTouchingButton) {
                    shootButtonPressed = false;
                    shootButton.classList.remove('active');
                }
            };

            handlePauseButtonTapRef = function handlePauseButtonTap(e) {
                e.preventDefault();
                togglePause();
            };

            // --- Add Event Listeners ---
            document.addEventListener('keydown', handleKeyDownRef);
            document.addEventListener('keyup', handleKeyUpRef);
            if (restartButton) restartButton.addEventListener('click', handleRestartClickRef);
            if (resumeButton) resumeButton.addEventListener('click', handleResumeClickRef);
            if (pauseRestartButton) pauseRestartButton.addEventListener('click', handlePauseRestartClickRef);
            if (shootSoundToggleButton) shootSoundToggleButton.addEventListener('click', handleShootToggleRef);
            if (enemyHitSoundToggleButton) enemyHitSoundToggleButton.addEventListener('click', handleEnemyHitSoundToggleRef);

            if (touchDevice) {
                console.log("Touch device detected, enabling touch controls.");
                if (touchControlsContainer) touchControlsContainer.style.display = 'block';
                if (controlInstructionsDisplay) controlInstructionsDisplay.textContent = 'Move, Pause, Shoot';

                joystickBase.addEventListener('touchstart', handleJoystickStartRef, { passive: false });
                joystickBase.addEventListener('touchmove', handleJoystickMoveRef, { passive: false });
                joystickBase.addEventListener('touchend', handleJoystickEndRef, { passive: false });
                joystickBase.addEventListener('touchcancel', handleJoystickEndRef, { passive: false });

                shootButton.addEventListener('touchstart', handleShootButtonStartRef, { passive: false });
                shootButton.addEventListener('touchend', handleShootButtonEndRef, { passive: false });
                shootButton.addEventListener('touchcancel', handleShootButtonEndRef, { passive: false });

                if (pauseButton) pauseButton.addEventListener('touchstart', handlePauseButtonTapRef, { passive: false });

            } else {
                console.log("No touch support detected.");
                if (touchControlsContainer) touchControlsContainer.style.display = 'none';
                if (controlInstructionsDisplay) controlInstructionsDisplay.textContent = 'Arrow Keys (Move), Space (Shoot), Esc (Pause)';
                if (gameContainer) gameContainer.style.minWidth = '520px';
                if (gameContainer) gameContainer.style.minHeight = '720px';
            }

            // --- Game Logic Functions (Defined within initGame scope) ---
            function updateSoundTogglesUI() {
                if (shootSoundToggleButton) { shootSoundToggleButton.textContent = `Shoot FX: ${shootSoundEnabled ? 'ON' : 'OFF'}`; shootSoundToggleButton.classList.toggle('sound-toggle-on', shootSoundEnabled); shootSoundToggleButton.classList.toggle('sound-toggle-off', !shootSoundEnabled); }
                if (enemyHitSoundToggleButton) { enemyHitSoundToggleButton.textContent = `Hit FX: ${enemyHitSoundEnabled ? 'ON' : 'OFF'}`; enemyHitSoundToggleButton.classList.toggle('sound-toggle-on', enemyHitSoundEnabled); enemyHitSoundToggleButton.classList.toggle('sound-toggle-off', !enemyHitSoundEnabled); }
            }
            function updateLivesDisplay() { if (livesDisplay) { const heartEmoji = '❤️'; const displayLives = Math.max(0, lives); livesDisplay.textContent = heartEmoji.repeat(displayLives); } }
            function togglePause() { if (gameOver) return; isPaused = !isPaused; if (isPaused) { gameRunning = false; updateSoundTogglesUI(); if (pauseMenu) pauseMenu.style.display = 'block'; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } } else { resumeGame(); } }
            function resumeGame() { if (!gameOver) { isPaused = false; gameRunning = true; if (pauseMenu) pauseMenu.style.display = 'none'; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } animationFrameId = requestAnimationFrame(gameLoop); } }
            function drawPlayer() {
                if (player.invulnerable && Math.floor(player.invulnerableTimer / 6) % 2 === 0) { return; }

                let currentImage = isEvolved ? playerEvolvedImage : playerImage;
                let currentImageLoaded = isEvolved ? playerEvolvedImageLoaded : playerImageLoaded;

                if (currentImageLoaded) {
                    ctx.drawImage(currentImage, player.x, player.y, player.width, player.height);
                } else {
                    ctx.fillStyle = player.fallbackColor;
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                    if (isEvolved) {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(player.x + player.width * 0.2, player.y + player.height * 0.2, player.width * 0.6, player.height * 0.6);
                    }
                }
            }
            function drawBullets() { ctx.fillStyle = '#FFFFFF'; bullets.forEach(bullet => { ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height); }); ctx.fillStyle = '#FF4444'; enemyBullets.forEach(bullet => { ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height); }); }
            function drawEnemies() { enemies.forEach(enemy => { ctx.font = `${enemy.height * 0.8}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(enemy.emoji, enemy.x + enemy.width / 2, enemy.y + enemy.height / 2); }); }
            function updateJoystick(clientX, clientY) {
                let deltaX = clientX - joystickStartX;
                let deltaY = clientY - joystickStartY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

                let moveX = deltaX;
                let moveY = deltaY;

                if (distance > currentMaxJoystickDisplacement) {
                    const ratio = currentMaxJoystickDisplacement / distance;
                    moveX = deltaX * ratio;
                    moveY = deltaY * ratio;
                }

                joystickKnob.style.transform = `translate(${moveX}px, ${moveY}px)`;

                let normalizedX = 0;
                let normalizedY = 0;
                if (distance > 5) {
                    normalizedX = deltaX / distance;
                    normalizedY = deltaY / distance;
                }

                let currentSpeed = player.speed;
                if (isEventActive && currentEvent === 'depression') {
                    currentSpeed *= DEPRESSION_MOVE_FACTOR;
                }
                if (isEventActive && currentEvent === 'fever') {
                    currentSpeed *= FEVER_PLAYER_SPEED_MULTIPLIER;
                }

                player.dx = normalizedX * currentSpeed;
                player.dy = normalizedY * currentSpeed;
            }
            function updatePlayer() {
                if (player.invulnerable) { player.invulnerableTimer--; if (player.invulnerableTimer <= 0) { player.invulnerable = false; } }

                let currentSpeed = player.speed;
                let currentShootCooldown = player.shootCooldownDuration;

                if (isEventActive && currentEvent === 'depression') {
                    currentSpeed *= DEPRESSION_MOVE_FACTOR;
                    currentShootCooldown *= DEPRESSION_SHOOT_FACTOR;
                }
                if (isEventActive && currentEvent === 'fever') {
                    currentSpeed *= FEVER_PLAYER_SPEED_MULTIPLIER;
                    currentShootCooldown *= FEVER_SHOOT_COOLDOWN_MULTIPLIER;
                }
                if (isEventActive && currentEvent === 'heart_attack') {
                    currentShootCooldown *= HEART_ATTACK_SHOOT_COOLDOWN_MULTIPLIER;
                }

                if (!joystickActive) {
                    player.dx = 0; player.dy = 0;
                    if (keys['ArrowLeft'] && player.x > 0) player.dx = -currentSpeed;
                    if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.dx = currentSpeed;
                    if (keys['ArrowUp'] && player.y > 0) player.dy = -currentSpeed;
                    if (keys['ArrowDown'] && player.y < canvas.height - player.height) player.dy = currentSpeed;
                }

                player.x += player.dx;
                player.y += player.dy;

                if (isEventActive && currentEvent === 'heart_attack') {
                    if (eventTimer % 5 < 2) {
                        player.x += (Math.random() - 0.5) * HEART_ATTACK_INTENSITY;
                    }
                }

                player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
                player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));

                if (player.shootCooldown > 0) player.shootCooldown--;
                if ((keys['Space'] || shootButtonPressed) && player.shootCooldown === 0 && !player.invulnerable) {
                    shoot();
                    player.shootCooldown = Math.max(1, Math.round(currentShootCooldown));
                }
            }
            function shoot() {
                const bulletWidth = 5;
                const bulletHeight = 10;
                const bulletSpeed = 7;
                const bulletY = player.y;

                if (isEvolved) {
                    const bulletXOffset = player.width / 4;
                    const bullet1 = { x: player.x + bulletXOffset - bulletWidth / 2, y: bulletY, width: bulletWidth, height: bulletHeight, speed: bulletSpeed };
                    const bullet2 = { x: player.x + player.width - bulletXOffset - bulletWidth / 2, y: bulletY, width: bulletWidth, height: bulletHeight, speed: bulletSpeed };
                    bullets.push(bullet1, bullet2);
                } else {
                    const bullet = { x: player.x + player.width / 2 - bulletWidth / 2, y: bulletY, width: bulletWidth, height: bulletHeight, speed: bulletSpeed };
                    bullets.push(bullet);
                }
                playShootSound();
            }
            function enemyShoot(enemy) {
                const difficultyLevel = Math.floor((lifespan - 50) / 10) + 1;
                const bulletWidth = 6; const bulletHeight = 6;
                let bulletSpeed = 3 + difficultyLevel * 0.2;

                if (isEventActive && currentEvent === 'fever') {
                    bulletSpeed *= FEVER_BULLET_SPEED_MULTIPLIER;
                }

                const bullet = { x: enemy.x + enemy.width / 2 - bulletWidth / 2, y: enemy.y + enemy.height, width: bulletWidth, height: bulletHeight, speed: bulletSpeed };
                enemyBullets.push(bullet);
            }
            function updateBullets() { for (let i = bullets.length - 1; i >= 0; i--) { bullets[i].y -= bullets[i].speed; if (bullets[i].y + bullets[i].height < 0) { bullets.splice(i, 1); } } for (let i = enemyBullets.length - 1; i >= 0; i--) { enemyBullets[i].y += enemyBullets[i].speed; if (enemyBullets[i].y > canvas.height) { enemyBullets.splice(i, 1); } } }
            function spawnEnemy() {
                const difficultyLevel = Math.floor((lifespan - 50) / 10) + 1;
                let enemySize = 30;
                let enemyHealth = 1;
                const randomEmoji = enemyEmojis[Math.floor(Math.random() * enemyEmojis.length)];

                if (isEventActive && currentEvent === 'cancer') {
                    enemySize *= CANCER_ENEMY_SIZE_FACTOR;
                    enemyHealth = CANCER_ENEMY_HEALTH;
                }

                const enemy = {
                    x: Math.random() * (canvas.width - enemySize),
                    y: -enemySize,
                    width: enemySize,
                    height: enemySize,
                    speed: 1 + difficultyLevel * 0.25,
                    emoji: randomEmoji,
                    shootCooldown: Math.random() * 100 + 50,
                    health: enemyHealth
                };
                enemies.push(enemy);
            }
            function updateEnemies() {
                const difficultyLevel = Math.floor((lifespan - 50) / 10) + 1;
                let currentSpawnInterval = Math.max(20, baseEnemySpawnInterval - difficultyLevel * 5);

                if (isEventActive && currentEvent === 'fever') {
                    currentSpawnInterval *= FEVER_SPAWN_INTERVAL_MULTIPLIER;
                    currentSpawnInterval = Math.max(10, currentSpawnInterval);
                }

                enemySpawnTimer++;
                if (enemySpawnTimer >= currentSpawnInterval) {
                    spawnEnemy();
                    enemySpawnTimer = 0;
                }

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    enemy.y += enemy.speed;
                    enemy.shootCooldown--;
                    if (enemy.shootCooldown <= 0 && enemy.y > 10 && enemy.y < canvas.height * 0.65) {
                        enemyShoot(enemy);
                        let newCooldown = 120 + Math.random() * 100 - difficultyLevel * 5;
                        if (isEventActive && currentEvent === 'fever') {
                            newCooldown *= FEVER_SHOOT_COOLDOWN_MULTIPLIER;
                        }
                        enemy.shootCooldown = Math.max(MIN_ENEMY_SHOOT_COOLDOWN, newCooldown);
                    }
                    if (enemy.y > canvas.height) {
                        enemies.splice(i, 1);
                    }
                }
            }
            function checkCollisions() {
                for (let i = bullets.length - 1; i >= 0; i--) {
                    if (!bullets[i]) continue;
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        if (!enemies[j]) continue;
                        if (isColliding(bullets[i], enemies[j])) {
                            enemies[j].health--;
                            bullets.splice(i, 1);
                            if (enemies[j].health <= 0) {
                                let enemyScore = 100;
                                if (isEventActive) { enemyScore *= EVENT_SCORE_MULTIPLIER; }
                                score += enemyScore;
                                updateScore();
                                playEnemyHitSound();
                                enemies.splice(j, 1);
                            }
                            break;
                        }
                    }
                }
                if (player.invulnerable) { return; }
                for (let i = enemyBullets.length - 1; i >= 0; i--) {
                    if (isColliding(enemyBullets[i], player)) {
                        enemyBullets.splice(i, 1);
                        handlePlayerHit();
                        return;
                    }
                }
                for (let i = enemies.length - 1; i >= 0; i--) {
                    if (!enemies[i]) continue;
                    if (isColliding(enemies[i], player)) {
                        handlePlayerHit();
                        enemies[i].health -= 2;
                        if (enemies[i].health <= 0) {
                            enemies.splice(i, 1);
                            playEnemyHitSound();
                        }
                        return;
                    }
                }
            }
            function isColliding(rect1, rect2) { if (!rect1 || !rect2) return false; return rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x && rect1.y < rect2.y + rect2.height && rect1.y + rect1.height > rect2.y; }
            function updateScore() {
                if (scoreDisplay) scoreDisplay.textContent = `Score ${score}`;
                if (score >= lifespanIncreaseScore && lifespan < maxLifespan) {
                    lifespan++;
                    lifespanIncreaseScore += 50 + (lifespan - 50) * 10;
                    if (lifespanDisplay) lifespanDisplay.textContent = `Lifespan ${lifespan}`;
                    console.log(`Lifespan increased to ${lifespan}. Next at ${lifespanIncreaseScore} score.`);

                    if (lifespan >= evolutionLifespan && !isEvolved) {
                        isEvolved = true;
                        console.log(`Player Evolved at Lifespan ${lifespan}!`);
                    }
                }
            }
            function triggerGameOver() { gameOver = true; gameRunning = false; if (finalScoreDisplay) finalScoreDisplay.textContent = `Final Score ${score} | Max Lifespan ${lifespan}`; if (gameOverBox) gameOverBox.style.display = 'block'; if (pauseMenu) pauseMenu.style.display = 'none'; if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } }
            function handlePlayerHit() { if (player.invulnerable) return; lives--; updateLivesDisplay(); playPlayerHitSound(); if (lives <= 0) { triggerGameOver(); } else { player.invulnerable = true; player.invulnerableTimer = 120; const clearRadius = 75; for (let i = enemyBullets.length - 1; i >= 0; i--) { const bullet = enemyBullets[i]; const dx = (bullet.x + bullet.width / 2) - (player.x + player.width / 2); const dy = (bullet.y + bullet.height / 2) - (player.y + player.height / 2); if (Math.sqrt(dx * dx + dy * dy) < clearRadius) { enemyBullets.splice(i, 1); } } } }
            function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
            function updateEventStatus() {
                if (!eventStatusDisplay) return;
                if (isEventActive) {
                    let eventName = currentEvent.replace('_', ' ').toUpperCase();
                    let timeLeft = (eventTimer / 60).toFixed(1);
                    eventStatusDisplay.textContent = `${eventName} (${timeLeft}s)`;
                    eventStatusDisplay.style.color = 'white';
                    eventStatusDisplay.style.backgroundColor = '#ff0000';
                    eventStatusDisplay.style.fontSize = '16px';
                    eventStatusDisplay.style.fontWeight = 'bold';
                    eventStatusDisplay.style.textShadow = '2px 2px 4px #000';
                    eventStatusDisplay.style.padding = '4px 10px';
                    eventStatusDisplay.style.borderRadius = '5px';
                } else {
                    eventStatusDisplay.textContent = '';
                    eventStatusDisplay.style.backgroundColor = '';
                    eventStatusDisplay.style.fontSize = '';
                    eventStatusDisplay.style.fontWeight = '';
                    eventStatusDisplay.style.textShadow = '';
                    eventStatusDisplay.style.padding = '';
                    eventStatusDisplay.style.borderRadius = '';
                    eventStatusDisplay.style.color = 'yellow';
                }
            }

            function gameLoop() {
                if (gameRunning) {
                    if (!isEventActive) {
                        if (eventCooldownTimer > 0) {
                            eventCooldownTimer--;
                        } else {
                            isEventActive = true;
                            currentEvent = healthEvents[Math.floor(Math.random() * healthEvents.length)];
                            const lifespanDifference = Math.max(0, lifespan - 50);
                            const extraDurationFrames = lifespanDifference * EVENT_DURATION_INCREASE_PER_LIFESPAN_FRAMES;
                            eventTimer = EVENT_DURATION + extraDurationFrames;
                            console.log(`Event started: ${currentEvent}, Duration: ${(eventTimer / 60).toFixed(1)}s (Base: ${EVENT_DURATION / 60}s, Extra: ${extraDurationFrames / 60}s)`);
                        }
                    } else {
                        if (eventTimer > 0) {
                            eventTimer--;
                        } else {
                            isEventActive = false;
                            currentEvent = null;
                            eventCooldownTimer = EVENT_COOLDOWN;
                            console.log("Event ended");
                        }
                    }

                    clearCanvas();
                    updatePlayer();
                    updateBullets();
                    updateEnemies();
                    checkCollisions();
                    updateEventStatus();

                    drawPlayer();
                    drawBullets();
                    drawEnemies();

                    animationFrameId = requestAnimationFrame(gameLoop);
                }
            }

            updateScore(); updateLivesDisplay();
            if (lifespanDisplay) lifespanDisplay.textContent = `Lifespan ${lifespan}`;
            updateSoundTogglesUI();
            gameRunning = true;
            if (gameOverBox) gameOverBox.style.display = 'none';
            if (pauseMenu) pauseMenu.style.display = 'none';
            if (eventStatusDisplay) eventStatusDisplay.textContent = '';
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(gameLoop);

        }

        function restartGame() {
            console.log("Restart button clicked! Reloading page...");
            window.location.reload();
        }

        window.onload = initGame;

    </script>
</body>

</html>